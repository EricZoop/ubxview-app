import{g as G,o as Te,r as Be,a as Fe}from"./sceneManager-3h6Dk_hR.js";import{T as Ce,C as te,L as ne,P as re,M as ze,D as se,a as ce,S as Oe,N as ke,b as Re,e as de,c as ue,d as fe,u as T,i as Ge,f as Ae,s as De}from"./index-Be8rz_-K.js";import{getBoundingBox as pe,getGpsToCartesian as We,getFloorY as Ze,plotGpsData as B,initializeCoordinateSystem as me,resetCoordinateSystem as Ve}from"./plotManager-DLvm3R7D.js";const U={satellite:{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",name:"Satellite"},streetview:{url:"https://server.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",name:"Topographic"}},x={initialOpacity:.5,initialTileService:"satellite",zoomLevel:17,adsbZoomLevel:11,radarZoomLevel:11,initialRenderDistance:5};function ie(e,t,n){const a=Math.pow(2,n),i=Math.floor(a*((e+180)/360)),o=t*Math.PI/180,l=Math.floor(a*(1-Math.log(Math.tan(o)+1/Math.cos(o))/Math.PI)/2);return{x:Math.max(0,Math.min(a-1,i)),y:Math.max(0,Math.min(a-1,l))}}function V(e,t,n){const a=Math.pow(2,n),i=e/a*360-180,l=Math.atan(Math.sinh(Math.PI*(1-2*t/a)))*180/Math.PI;return{lon:i,lat:l}}function $e(e,t,n=5e3){return new Promise((a,i)=>{const o=setTimeout(()=>{i(new Error(`Timeout loading texture: ${t}`))},n);e.load(t,l=>{clearTimeout(o),a(l)},void 0,l=>{clearTimeout(o),i(l)})})}let X=x.initialTileService,$=x.initialOpacity,ye=x.zoomLevel,w=null;const He=.51;let S=null;function he(e){ye=e}async function J(){const{tileGroup:e}=G(),t=window.getCurrentRenderDistance?window.getCurrentRenderDistance():x.initialRenderDistance,n=pe(),a=We();if(!n||!a){console.error("Bounding box or GPS conversion not available.");return}for(;e.children.length>0;){const p=e.children[0];e.remove(p),p.geometry&&p.geometry.dispose(),p.material&&(p.material.map&&p.material.map.dispose(),p.material.dispose())}const i=ye,{minLon:o,maxLon:l,minLat:s,maxLat:d}=n,y=ie(o,d,i),c=ie(l,s,i),u={x:y.x-t,y:y.y-t},r={x:c.x+t,y:c.y+t},g={x:Math.floor((y.x+c.x)/2),y:Math.floor((y.y+c.y)/2)};if(isNaN(u.x)||isNaN(u.y)||isNaN(r.x)||isNaN(r.y)||r.x<u.x||r.y<u.y||r.x-u.x>1e3||r.y-u.y>1e3){console.error("Invalid tile coordinate range:",{minTile:u,maxTile:r,boundingBox:n});return}const P=V(u.x,u.y,i),Z=V(r.x+1,r.y+1,i),C=a({lat:P.lat,lon:P.lon}),E=a({lat:Z.lat,lon:Z.lon});S={minX:Math.min(C.x,E.x),maxX:Math.max(C.x,E.x),minZ:Math.min(C.z,E.z),maxZ:Math.max(C.z,E.z)};const z=[];for(let p=u.x;p<=r.x;p++)for(let b=u.y;b<=r.y;b++)z.push({x:p,y:b});z.sort((p,b)=>Math.hypot(p.x-g.x,p.y-g.y)-Math.hypot(b.x-g.x,b.y-g.y));const k=Ze();console.log(`Loading ${z.length} tiles at zoom ${i}, floorY=${k.toFixed(1)}`);const R=new Ce,Ie=z.map(({x:p,y:b})=>_e(p,b,i,R,a,k).catch(()=>null));await Promise.all(Ie),Ne(k),console.log("Finished loading tiles.")}async function _e(e,t,n,a,i,o){const{tileGroup:l}=G(),d=U[X].url.replace("{z}",n).replace("{y}",t).replace("{x}",e),y=V(e,t,n),c=V(e+1,t+1,n),u=i({lat:y.lat,lon:y.lon}),r=i({lat:c.lat,lon:c.lon}),g=Math.abs(r.x-u.x),P=Math.abs(r.z-u.z),Z=(u.x+r.x)/2,C=(u.z+r.z)/2,E=await $e(a,d,5e3);E.wrapS=te,E.wrapT=te,E.minFilter=ne,E.magFilter=ne;const z=new re(g,P),k=new ze({map:E,side:se,transparent:!0,opacity:$}),R=new ce(z,k);R.rotation.x=-Math.PI/2,R.position.set(Z,o-.1,C),l.add(R)}function Ne(e){const{scene:t}=G();if(w&&(t.remove(w),w.geometry&&w.geometry.dispose(),w.material&&w.material.dispose(),w=null),!S)return;const n=S.maxX-S.minX,a=S.maxZ-S.minZ,i=(S.minX+S.maxX)/2,o=(S.minZ+S.maxZ)/2,l=Math.max(n,a)/80,s=new Oe({uniforms:{uGridColor:{value:new Re(7829367)},uGridSize:{value:l},uLineWidth:{value:.5},uOpacity:{value:.55}},depthWrite:!1,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:-8,polygonOffsetUnits:-8,transparent:!0,alphaTest:.01,blending:ke,side:se,vertexShader:`
            varying vec3 vWorldPos;
            void main() {
                vec4 worldPosition = modelMatrix * vec4(position, 1.0);
                vWorldPos = worldPosition.xyz;
                gl_Position = projectionMatrix * viewMatrix * worldPosition;
            }
        `,fragmentShader:`
            uniform vec3 uGridColor;
            uniform float uGridSize;
            uniform float uLineWidth;
            uniform float uOpacity;
            varying vec3 vWorldPos;
            void main() {
                vec2 coord = vWorldPos.xz / uGridSize;
                vec2 grid = abs(fract(coord - 0.5) - 0.5) / fwidth(coord);
                float line = min(grid.x, grid.y);
                float alpha = 1.0 - smoothstep(0.0, uLineWidth, line);
                alpha *= uOpacity;
                if (alpha < 0.01) discard;
                gl_FragColor = vec4(uGridColor, alpha);
            }
        `}),d=new ce(new re(n,a),s);d.rotation.x=-Math.PI/2,d.position.set(i,e,o),d.renderOrder=-1,w=d,t.add(w),ge()}function ge(){w&&(w.visible=$<He)}function ae(e){const{tileGroup:t}=G();$=parseFloat(e),t.children.forEach(n=>{n.material&&(n.material.opacity=$)}),ge()}function Ue(e){e!==X&&U[e]&&(X=e,console.log("Switched to tile service:",U[e].name),pe()&&J())}let Q=[],Y=[],m=[],j=[],f=0,A=!1,M=!0,I=null,O=1;const Xe=100,ve=100;function Ye(){const e=[];for(const t of Y)t&&t.length&&e.push(...t);m=e.sort((t,n)=>t.time-n.time)}function je(){return Q}function qe(e){const t=O;O=e,console.log(`Playback speed ${t}x â†’ ${e}x`),A&&I&&(clearInterval(I),xe()),nt()}function q(){return{isLiveMode:M,isPlaying:A,currentPointIndex:f,totalLines:Q.length,totalPoints:m.length,progress:m.length>0?f/(m.length-1):0,playbackSpeed:O}}function K(e){j=e||[]}function H(e){Q=e;const t=Pe();if(t==="radar"){const n=e.join(`
`);Y=[de(n)||[]]}else Y=e.map(n=>t==="adsb"?ue(n)||[]:fe(n)||[]);Ye(),f=Math.max(0,m.length-1),W()}function Je(){const e=document.getElementById("timeSlider");e&&m.length>0&&(e.max=m.length-1,M&&(f=m.length-1,e.value=f))}function Qe(){return Xe/O}function xe(){f>=m.length-1&&(f=0),I=setInterval(()=>{f<m.length-1?(f++,W(),D()):ee()},Qe())}function Ke(){I&&clearInterval(I),A=!0,Le(),xe()}function ee(){I&&(clearInterval(I),I=null),A=!1,Le()}function et(){M&&_(),f=Math.max(0,f-ve),W(),D()}function tt(){M&&_(),f=Math.min(m.length-1,f+ve),W(),D()}function _(){M=!1,Ee()}function we(){M=!0,ee(),f=Math.max(0,m.length-1),W(),Ee(),D()}function D(){Pe();const e=m.slice(0,f+1);let t=e;if(j.length>0){const n=m[f]?.time??1/0,a=j.filter(i=>i.time<=n);t=[...e,...a]}B(t,!1),T(t)}function W(){const e=document.getElementById("timeSlider");e&&m.length>0&&(e.max=m.length-1,e.value=f)}function Le(){const e=document.getElementById("playIcon"),t=document.getElementById("pauseIcon");A?(e&&(e.style.display="none"),t&&(t.style.display="inline")):(e&&(e.style.display="inline"),t&&(t.style.display="none"))}function Ee(){const e=document.getElementById("goLive");e&&(e.style.opacity=M?"0.5":"1.0",e.disabled=M)}function nt(){const e=document.getElementById("currentSpeedDisplay");e&&(e.textContent=`${O}x`),document.querySelectorAll(".speed-option").forEach(t=>{t.classList.toggle("active",parseFloat(t.dataset.speed)===O)})}function Se(e){M&&_(),f=parseInt(e.target.value),D()}function it(e){const t=parseFloat(e.target.dataset.speed);if(!isNaN(t)&&t>0){qe(t);const n=document.getElementById("speedOptions");n&&n.classList.remove("show")}}function at(){const e=document.getElementById("timeSlider");e&&(["mousedown","mousemove","mouseup","click"].forEach(t=>{e.addEventListener(t,n=>n.stopPropagation())}),e.addEventListener("input",Se))}const h=new Map;let v=null,ot=1,lt=10;const L=new Set,rt='<svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 576 512"><path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 92.9-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.8-35.7-46.1-87.7-92.9-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0a144 144 0 1 1-288 0zm144-64a64 64 0 1 1 0 128a64 64 0 0 1 0-128z"/></svg>',st='<svg class="trash-icon" xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 448 512"><path fill="currentColor" d="M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>',ct='<svg class="overlay-icon" fill="currentColor" width="14" height="14" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M28,8H24V4a2.0023,2.0023,0,0,0-2-2H4A2.0023,2.0023,0,0,0,2,4V22a2.0023,2.0023,0,0,0,2,2H8v4a2.0023,2.0023,0,0,0,2,2H28a2.0023,2.0023,0,0,0,2-2V10A2.0023,2.0023,0,0,0,28,8ZM4,22V4H22V8H10a2.0023,2.0023,0,0,0-2,2V22Zm18,0H19.4141L10,12.586V10h2.5859l9.4153,9.4156ZM10,15.4141,16.5859,22H10ZM22.001,16.587,15.4141,10H22ZM10,28V24H22a2.0023,2.0023,0,0,0,2-2V10h4V28Z"/></svg>';function N(e,t){return t==="adsb"?ue(e):t==="radar"?de(e):fe(e)}async function dt(){const e=[];for(const t of L){const n=h.get(t);if(n)try{const i=await(await n.handle.getFile()).text();e.push(...N(i,n.type))}catch(a){console.error(`Overlay read failed for file ${t}:`,a)}}return e}async function Me(){if(!v)return;const e=h.get(v);if(e)try{const n=await(await e.handle.getFile()).text(),a=N(n,e.type),i=await dt();K(i);const o=[...a,...i];if(o.length===0)return;B(o,!1),T(o,e.type)}catch(t){console.error("rerenderWithOverlays failed:",t)}}function ut(e){const t=h.get(e);if(t)if(t.watcherInterval&&clearInterval(t.watcherInterval),L.delete(e),h.delete(e),e===v){const n=[...h.keys()];n.length>0?(v=null,be(n[n.length-1])):(v=null,H([]),B([]),T([]),Ve(),F())}else(L.size>0||e!==v)&&Me(),F()}function Pe(){return v&&h.get(v)?.type||null}function F(){const e=document.getElementById("fileListContainer");if(!e)return;e.innerHTML="",h.size===0?e.style.display="none":e.style.display="flex";const t=Array.from(h.entries());t.forEach(([i,o],l)=>{const s=i===v,d=L.has(i),y=l===t.length-1,c=document.createElement("div");c.className=s?"active":"",c.dataset.fileId=i,c.style.cssText=`
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.6em 0.8em;
            border: 1px solid ${s?"#f0f0f0":d?"#5588cc":"#333"};
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.85em;
            color: ${s?"#e0e0e0":"#eee"};
            background: #1a1a1a;
            margin-bottom: ${y?"0":"5px"};
            user-select: none;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            font-family: inherit;
            transition: border 0.2s ease;
        `;let u=`
            <span style="flex:1; min-width:0; overflow:hidden; white-space:nowrap;" title="${o.name}">
                ${o.name}
            </span>
            ${s?`<span style="flex-shrink:0; opacity:1; line-height:0; margin-left:auto;">
                        ${rt}
                    </span>`:""}
        `;if(s||(u+=`
                <span class="overlay-btn" data-overlaid="${d}"
                      style="flex-shrink:0; line-height:0; color:${d?"#4e9bff":"#8888884c"}; transition:color 0.15s ease;"
                      title="${d?"Remove overlay":"Overlay onto current scene"}">
                    ${ct}
                </span>
                <span class="trash-btn" style="flex-shrink:0; line-height:0; color:#8888884c; transition:color 0.15s ease;" title="Remove">
                    ${st}
                </span>
            `),c.innerHTML=u,c.addEventListener("click",r=>{r.target.closest(".trash-btn")||r.target.closest(".overlay-btn")||be(i)}),!s){const r=c.querySelector(".trash-btn");r&&(r.addEventListener("mouseenter",()=>{r.style.color="#e03c3c"}),r.addEventListener("mouseleave",()=>{r.style.color="#8888884c"}),r.addEventListener("click",P=>{P.stopPropagation(),ut(i)}));const g=c.querySelector(".overlay-btn");g&&(g.addEventListener("mouseenter",()=>{L.has(i)||(g.style.color="#4e9bff")}),g.addEventListener("mouseleave",()=>{g.style.color=L.has(i)?"#4e9bff":"#8888884c"}),g.addEventListener("click",async P=>{P.stopPropagation(),L.has(i)?L.delete(i):L.add(i),F(),await Me()}))}e.appendChild(c)});const n=document.getElementById("addFileBtn");n&&(n.style.display=h.size>0?"":"none");const a=document.getElementById("openFileBtn");a&&h.size>0?a.style.display="none":a&&(a.style.display="")}async function be(e){if(e===v)return;const t=h.get(e);if(!t)return;L.clear(),K([]),v=e,he(t.type==="adsb"?x.adsbZoomLevel:t.type==="radar"?x.radarZoomLevel:x.zoomLevel);const a=await(await t.handle.getFile()).text(),i=t.type==="radar"?[a]:a.split(`
`).filter(s=>s.trim());H(i);const o=N(a,t.type);if(o.length===0){B([]),T([],t.type),F();return}me(o);const l=B(o,!1);T(o,t.type),F(),l&&window.dispatchEvent(new CustomEvent("fileLoaded",{detail:l}))}async function ft(e){const t=h.get(e);if(!(!t||!t.handle||t.isWatcherRunning)&&t.type!=="radar"){t.isWatcherRunning=!0;try{const n=await t.handle.getFile();if(n.size>t.readOffset){const a=await n.slice(t.readOffset).text();if(t.readOffset=n.size,a.length>0&&e===v){const i=a.split(`
`).filter(l=>l.trim()),o=[...je(),...i];H(o),q().isLiveMode?we():Je()}}}catch(n){console.error(`Error watching file ${e}:`,n)}finally{t.isWatcherRunning=!1}}}function pt(e){const t=h.get(e);!t||t.type==="radar"||(t.watcherInterval&&clearInterval(t.watcherInterval),t.watcherInterval=setInterval(()=>ft(e),lt))}async function oe(e){try{const[t]=await window.showOpenFilePicker({types:[{accept:{"text/plain":[".txt",".log",".csv",".ubx",".crswap",".bin",".json",".ndjson"]}}],multiple:!1});if(!t)return!1;const n=await t.getFile(),a=await n.text();let i;Ge(a)?i="radar":(i=Ae(a),i==="unknown"&&(i="nmea"));const o=ot++;h.set(o,{id:o,handle:t,name:n.name,type:i,readOffset:n.size,watcherInterval:null,isWatcherRunning:!1}),L.clear(),K([]),v=o,he(i==="adsb"?x.adsbZoomLevel:i==="radar"?x.radarZoomLevel:x.zoomLevel);const l=i==="radar"?[a]:a.split(`
`).filter(y=>y.trim());H(l);const s=N(a,i);if(s.length===0)return alert("No valid GPS / ADS-B / Radar points found."),B([]),T([],i),F(),!1;me(s);const d=B(s,!1);return T(s,i),F(),e&&d&&e(d),pt(o),!0}catch(t){return t.name!=="AbortError"&&console.error("File selection failed:",t),!1}}function mt(){const e=c=>{window.dispatchEvent(new CustomEvent("fileLoaded",{detail:c}))},t=document.getElementById("openFileBtn");t&&t.addEventListener("click",()=>oe(e));const n=document.getElementById("addFileBtn");n&&n.addEventListener("click",()=>oe(e));const a=document.getElementById("rewind");a&&a.addEventListener("click",et);const i=document.getElementById("playPause");i&&i.addEventListener("click",()=>{q().isLiveMode&&_(),q().isPlaying?ee():Ke()});const o=document.getElementById("forward");o&&o.addEventListener("click",tt);const l=document.getElementById("goLive");l&&l.addEventListener("click",we);const s=document.getElementById("timeSlider");s&&(s.addEventListener("input",Se),at());const d=document.getElementById("adjustSpeed"),y=document.getElementById("speedOptions");d&&y&&(d.addEventListener("click",c=>{c.stopPropagation(),y.classList.toggle("show")}),document.querySelectorAll(".speed-option").forEach(c=>{c.addEventListener("click",it)}),window.addEventListener("click",()=>y.classList.remove("show")))}function yt(){ht(),vt(),gt()}function ht(){const e=document.getElementById("opacitySlider");e&&(e.value=x.initialOpacity,ae(e.value),e.addEventListener("input",t=>{ae(t.target.value)}))}function gt(){document.querySelectorAll(".view-option").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".view-option").forEach(n=>n.classList.remove("active")),e.classList.add("active");const t=e.dataset.view;Ue(t)})})}function vt(){const e=document.getElementById("renderMinus"),t=document.getElementById("renderPlus"),n=document.getElementById("renderValue");let a=x.initialRenderDistance;const i=1,o=50,l=()=>{n&&(n.textContent=a),e&&(e.disabled=a<=i),t&&(t.disabled=a>=o)},s=d=>{a=Math.max(i,Math.min(o,d)),l(),J()};e&&e.addEventListener("click",()=>s(a-1)),t&&t.addEventListener("click",()=>s(a+1)),window.getCurrentRenderDistance=()=>a,l()}let le=!1;function Et(){const{controls:e}=G();window.addEventListener("resize",Te),window.addEventListener("fileLoaded",t=>{const n=t.detail;n&&(le||(Be(),Fe(),le=!0),e.reset(n.dataSpan,n.firstPointVec),J())}),De(),mt(),yt()}export{Et as initializeEventListeners};

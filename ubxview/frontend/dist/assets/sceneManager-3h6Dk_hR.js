import{V as a,O as U,S as $,D as J,N as Q,g as Z,b as H,a as q,P as ee,h as te,j as ie,G as _,k as ne,W as ae,l as se,A as oe,m as re,n as le}from"./index-Be8rz_-K.js";import{getLatestPoint as de}from"./plotManager-DLvm3R7D.js";function ce(t,f){const i=document.getElementById("cinematic-control-row"),h=document.getElementById("birdseye-control-row"),m=document.getElementById("reorient-control-row");let v=null,y=null,M=!1,I=!1,x=0,X=0;const l={};let c=!1,B=new a,z=null,L=null,d=!1,Y=t,u=null,C=t,V=new a,K=new a,R=1e3,A={x:Math.PI/6,y:Math.PI/4};const s={distance:1e3,angleX:Math.PI/6,angleY:Math.PI/4,panOffset:new a(0,0,0),moveSpeed:10,lookSpeed:.01,getCurrentCamera:function(){return C},updateCameraPosition:function(){if(d&&u){const e=Math.max(this.distance*2,2e3);u.position.set(this.panOffset.x,this.panOffset.y+e,this.panOffset.z),u.lookAt(this.panOffset);const n=window.innerWidth/window.innerHeight,r=this.distance*.8;u.left=-r*n,u.right=r*n,u.top=r,u.bottom=-r,u.near=.1,u.far=e*4,u.updateProjectionMatrix()}else{const e=Math.cos(this.angleY)*Math.cos(this.angleX)*this.distance,n=Math.sin(this.angleX)*this.distance,r=Math.sin(this.angleY)*Math.cos(this.angleX)*this.distance;C.position.set(e+this.panOffset.x,n+this.panOffset.y,r+this.panOffset.z),C.lookAt(this.panOffset)}},update:function(){c&&!d&&this.updateCinematic();const e=this.distance*.02,n=new a;C.getWorldDirection(n);let r;d?(r=new a(1,0,0),new a(0,0,-1)):(r=new a().crossVectors(C.up,n).normalize(),new a().crossVectors(n,r).normalize());let o=!1;if(c&&!d){const P=this.distance*.025;l.ArrowUp&&(this.distance=Math.max(30,this.distance-P),z=this.distance,o=!0),l.ArrowDown&&(this.distance+=P,z=this.distance,o=!0),l.ArrowLeft&&(this.angleY-=this.lookSpeed*1.5,o=!0),l.ArrowRight&&(this.angleY+=this.lookSpeed*1.5,o=!0)}if(l.KeyW&&(d?this.panOffset.add(new a(0,0,-e)):this.panOffset.add(n.clone().multiplyScalar(e)),o=!0),l.KeyS&&(d?this.panOffset.add(new a(0,0,e)):this.panOffset.add(n.clone().multiplyScalar(-e)),o=!0),l.KeyD&&(d?this.panOffset.add(new a(e,0,0)):this.panOffset.add(r.clone().multiplyScalar(-e)),o=!0),l.KeyA&&(d?this.panOffset.add(new a(-e,0,0)):this.panOffset.add(r.clone().multiplyScalar(e)),o=!0),d){const P=this.distance*.03;l.KeyQ&&(this.distance-=P,this.distance=Math.max(50,this.distance),o=!0),l.KeyE&&(this.distance+=P,o=!0)}else c||(l.KeyE&&(this.panOffset.add(new a(0,e,0)),o=!0),l.KeyQ&&(this.panOffset.add(new a(0,-e,0)),o=!0));!d&&!c&&(l.ArrowLeft&&(this.angleY-=this.lookSpeed,o=!0),l.ArrowRight&&(this.angleY+=this.lookSpeed,o=!0),l.ArrowUp&&(this.angleX+=this.lookSpeed,this.angleX=Math.min(Math.PI/2-.01,this.angleX),o=!0),l.ArrowDown&&(this.angleX-=this.lookSpeed,this.angleX=Math.max(-Math.PI/2+.01,this.angleX),o=!0)),o&&this.updateCameraPosition()},updateCinematic:function(){this.panOffset.lerp(B,.05);const e=z||1e3;this.distance+=(e-this.distance)*.05,this.updateCameraPosition()},toggleCinematicMode:function(){d&&this.toggleBirdseyeMode(),c=!c,c||(L=null,window.dispatchEvent(new CustomEvent("cinematicTargetChanged",{detail:{talkerId:null}}))),console.log(`Cinematic mode ${c?"enabled":"disabled"}`),i&&i.classList.toggle("active-mode",c),c&&(z=this.distance)},toggleBirdseyeMode:function(){if(d=!d,console.log(`Birdseye mode ${d?"enabled":"disabled"}`),h&&h.classList.toggle("active-mode",d),d){if(c&&(c=!1,L=null,i&&i.classList.remove("active-mode"),window.dispatchEvent(new CustomEvent("cinematicTargetChanged",{detail:{talkerId:null}}))),V.copy(Y.position),K.copy(this.panOffset),R=this.distance,A.x=this.angleX,A.y=this.angleY,!u){const e=this.distance*.5;u=new U(-e,e,e,-e,.1,1e7)}this.angleX=Math.PI/2,this.angleY=0,C=u,this.updateCameraPosition()}else C=Y,this.distance=R,this.angleX=A.x,this.angleY=A.y,this.panOffset.copy(K),this.updateCameraPosition()},isBirdseyeActive:function(){return d},setCinematicTarget:function(e){e instanceof a&&B.copy(e)},isCinematicActive:function(){return c},getTargetTalkerId:function(){return L},setTargetTalkerId:function(e){L=e,console.log(`Tracking ${e===null?"all tracks (latest point)":"talker: "+e}`),window.dispatchEvent(new CustomEvent("cinematicTargetChanged",{detail:{talkerId:L}}))},adjustForNewData:function(e,n){v=e,y=n;const r=Math.max(e*1.5,200);(Math.abs(this.distance-r)>this.distance*.5||this.distance===6e3)&&(this.distance=r),this.panOffset.lerp(n,.3),this.updateCameraPosition()},reset:function(e,n){c=!1,d=!1,L=null,C=Y,window.dispatchEvent(new CustomEvent("cinematicTargetChanged",{detail:{talkerId:null}})),i&&i.classList.remove("active-mode"),h&&h.classList.remove("active-mode"),v=e,y=n,this.distance=Math.max(e*1.5,200),this.panOffset.copy(n),this.angleX=Math.PI/6,this.angleY=Math.PI/4,this.updateCameraPosition()}};return document.addEventListener("keydown",e=>{if(c&&e.code.startsWith("Digit")){const n=e.code.replace("Digit","");if(n==="0")s.setTargetTalkerId(null);else{const r={1:"AA",2:"BB",3:"CC",4:"DD",5:"WW",6:"XX",7:"YY",8:"ZZ",9:"JJ"};s.setTargetTalkerId(r[n]||null)}return}if(e.code==="KeyB"){s.toggleBirdseyeMode();return}if(e.code==="KeyC"){s.toggleCinematicMode();return}if(e.code==="KeyR"){m&&(m.classList.add("active-mode"),setTimeout(()=>m.classList.remove("active-mode"),150)),v!==null&&y!==null&&s.reset(v,y);return}l[e.code]=!0}),document.addEventListener("keyup",e=>{l[e.code]=!1}),window.addEventListener("blur",()=>{for(const e in l)l[e]=!1}),document.addEventListener("mousedown",e=>{e.target.closest("#info")||e.target.closest(".talker-header")||(M=!0,I=e.shiftKey||e.button===1,x=e.clientX,X=e.clientY,e.button===1&&e.preventDefault())}),document.addEventListener("mouseup",()=>{M=!1,I=!1}),document.addEventListener("mousemove",e=>{if(!M)return;const n=e.clientX-x,r=e.clientY-X;if(I){const o=s.distance*.001;if(d)s.panOffset.x-=n*o,s.panOffset.z+=r*o;else{const P=new a;C.getWorldDirection(P);const j=new a().crossVectors(P,C.up).normalize(),F=new a().crossVectors(j,P).normalize();s.panOffset.add(j.multiplyScalar(-n*o)),s.panOffset.add(F.multiplyScalar(r*o))}}else d||(s.angleY+=n*.005,s.angleX+=r*.005,s.angleX=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,s.angleX)));x=e.clientX,X=e.clientY,s.updateCameraPosition()}),document.addEventListener("wheel",e=>{e.target.closest("#info")||(s.distance+=e.deltaY*.5,s.distance=Math.max(50,s.distance),c&&(z=s.distance),s.updateCameraPosition())}),document.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("activateCinematicForTalker",e=>{const{talkerId:n}=e.detail;c&&L===n?s.toggleCinematicMode():(c||s.toggleCinematicMode(),s.setTargetTalkerId(n))}),s}function he(t,f={}){const{size:i=4e5,gridSize:h=100,lineWidth:m=.5,color:v=7829367,renderOrder:y=0,opacity:M=.65}=f,I=new $({uniforms:{uGridColor:{value:new H(v)},uGridSize:{value:h},uLineWidth:{value:m},uOpacity:{value:M}},depthWrite:M>=.99,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:-10,polygonOffsetUnits:-10,transparent:!0,alphaTest:.01,blending:M<1?Q:Z,side:J,vertexShader:`
      varying vec3 vWorldPos;
      void main() {
        vec4 worldPosition = modelMatrix * vec4(position, 1.0);
        vWorldPos = worldPosition.xyz;
        gl_Position = projectionMatrix * viewMatrix * worldPosition;
      }
    `,fragmentShader:`
      uniform vec3 uGridColor;
      uniform float uGridSize;
      uniform float uLineWidth;
      uniform float uOpacity;
      varying vec3 vWorldPos;
      void main() {
        vec2 coord = vWorldPos.xz / uGridSize;
        vec2 grid = abs(fract(coord - 0.5) - 0.5) / fwidth(coord);
        float line = min(grid.x, grid.y);
        float alpha = 1.0 - smoothstep(0.0, uLineWidth, line);
        
        // Apply overall opacity
        alpha *= uOpacity;
        
        // Discard fully transparent pixels
        if (alpha < 0.01) discard;
        
        gl_FragColor = vec4(uGridColor, alpha);
      }
    `}),x=new q(new ee(i,i),I);return x.rotation.x=-Math.PI/2,x.position.y=-.1,x.renderOrder=y-1,t.add(x),x}const fe=`
<svg width="2" height="10" viewBox="0 0 2 10" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="2" height="10" fill="none" stroke="black" stroke-width="2"/>
  <line x1="1" y1="0" x2="1" y2="10" stroke="currentColor" stroke-width="1"/>
</svg>`,me=`
<svg width="2" height="15" viewBox="0 0 2 15" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="2" height="15" fill="none" stroke="black" stroke-width="2"/>
  <line x1="1" y1="0" x2="1" y2="15" stroke="currentColor" stroke-width="1.5"/>
</svg>`,pe=`
<svg width="2" height="20" viewBox="0 0 2 20" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="2" height="20" fill="none" stroke="black" stroke-width="2"/>
  <line x1="1" y1="0" x2="1" y2="20" stroke="currentColor" stroke-width="2"/>
</svg>`;let w={},T=[];const D=(t,f,{text:i,svg:h})=>{const m=document.createElement("div");m.className=`compass-label ${f}`;let v="";h&&(v+=h),i&&(v+=`<span class="compass-text">${i}</span>`),m.innerHTML=v;const y=new te(m);return t.add(y),y};function ue(t){Object.values(w).forEach(i=>i.parent?.remove(i)),T.forEach(i=>i.label.parent?.remove(i.label)),w={},T=[],w.n=D(t,"compass-cardinal",{text:"N"}),w.s=D(t,"compass-cardinal",{text:"S"}),w.e=D(t,"compass-cardinal",{text:"E"}),w.w=D(t,"compass-cardinal",{text:"W"});const f=1e5;for(let i=0;i<360;i+=5){if(i%90===0)continue;let h,m;i%45===0?(m="compass-tick-large",h={svg:pe}):i%15===0?(m="compass-tick-medium",h={svg:me}):(m="compass-tick-small",h={svg:fe});const v=D(t,m,h),y=(i-90)*(Math.PI/180),M=new a(f*Math.cos(y),0,f*Math.sin(y));T.push({label:v,relativePos:M})}}function Pe(){Object.values(w).forEach(t=>{t.parent&&t.parent.remove(t),t.element?.parentNode&&t.element.parentNode.removeChild(t.element)}),T.forEach(t=>{t.label.parent&&t.label.parent.remove(t.label),t.label.element?.parentNode&&t.label.element.parentNode.removeChild(t.label.element)}),w={},T=[]}function ge(t){if(Object.keys(w).length===0)return;const f=1e5,i=new a(t.position.x,0,t.position.z);w.n.position.copy(i).add(new a(0,0,-f)),w.s.position.copy(i).add(new a(0,0,f)),w.e.position.copy(i).add(new a(f,0,0)),w.w.position.copy(i).add(new a(-f,0,0)),T.forEach(h=>{h.label.position.copy(i).add(h.relativePos)})}let g,b,E,S,O,W,G,p,k=null;function we(){g=new ie,g.background=new H(328965),W=new _,G=new _,g.add(W),W.add(G),b=new ne(75,window.innerWidth/window.innerHeight,1,1e7),b.position.set(610,610,610),E=new ae({antialias:!0}),E.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(E.domElement),S=new se,S.setSize(window.innerWidth,window.innerHeight),S.domElement.style.position="absolute",S.domElement.style.top="0px",S.domElement.style.pointerEvents="none",document.body.appendChild(S.domElement),O=ce(b,E.domElement),g.add(new oe(4210752,1.5));const t=new re(16777215,1);t.position.set(0,100,50),g.add(t),p=new le(100),p.position.y=.1,g.add(p),b.lookAt(p.position),k=he(g),ue(g),N(),console.log("Scene initialized. Waiting for data file.")}function ve(){return{scene:g,camera:b,renderer:E,labelRenderer:S,controls:O,dataGroup:W,tileGroup:G,axesHelper:p}}function ye(){p&&(g.remove(p),p.geometry&&p.geometry.dispose(),p.material&&(Array.isArray(p.material)?p.material.forEach(t=>t.dispose()):p.material.dispose()),p=null),k&&(g.remove(k),k.geometry&&k.geometry.dispose(),k.material&&k.material.dispose(),k=null)}function N(){if(requestAnimationFrame(N),O.isCinematicActive&&O.isCinematicActive()){const f=O.getTargetTalkerId(),i=de(f);i&&O.setCinematicTarget(i)}O.update();const t=O.getCurrentCamera();ge(t),E.render(g,t),S.render(g,t)}function Ce(){b&&E&&(b.aspect=window.innerWidth/window.innerHeight,b.updateProjectionMatrix(),E.setSize(window.innerWidth,window.innerHeight),S.setSize(window.innerWidth,window.innerHeight))}const Se=Object.freeze(Object.defineProperty({__proto__:null,getSceneObjects:ve,initializeScene:we,onWindowResize:Ce,removeStartupHelpers:ye},Symbol.toStringTag,{value:"Module"}));export{Pe as a,ve as g,Ce as o,ye as r,Se as s};

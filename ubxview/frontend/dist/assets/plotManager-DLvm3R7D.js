import{o as I,p as T,q as p,r as z,t as E,v as S,V as v,B,F as C,S as F,w as k,x as G,y as O,z as _,E as j}from"./index-Be8rz_-K.js";const R=`
    attribute float pointSize;
    varying vec3 vColor;
    void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        gl_PointSize = pointSize;
        gl_Position = projectionMatrix * mvPosition;
    }
`,V=`
    varying vec3 vColor;
    void main() {
        vec2 c = gl_PointCoord - 0.5;
        if (dot(c, c) > 0.25) discard;
        gl_FragColor = vec4(vColor, 1.0);
    }
`;let x=null,d=null,b=null,m=null,y=null,r=[],g=new Map,u=null,M=null,A=null,h=!1;function N(){j(r,d)}function U(t=null){if(!r||r.length===0||!d)return null;if(t===null){const a=r[r.length-1];return d(a.lat,a.lon,a.alt)}const e=r.filter(a=>a.talkerId===t);if(e.length===0)return null;const n=e[e.length-1];return d(n.lat,n.lon,n.alt)}function X(){return m}function Y(t){x=t,I(t)}function K(){return d}function Q(){return r}function Z(){const t=h?u:m,e=h?A:y;return!t||e===null||e===void 0?0:(t.minAlt-e)*5}function tt(t){!t||t.length===0||(u=t.reduce((e,n)=>({minLat:Math.min(e.minLat,n.lat),maxLat:Math.max(e.maxLat,n.lat),minLon:Math.min(e.minLon,n.lon),maxLon:Math.max(e.maxLon,n.lon),minAlt:Math.min(e.minAlt,n.alt),maxAlt:Math.max(e.maxAlt,n.alt)}),{minLat:1/0,maxLat:-1/0,minLon:1/0,maxLon:-1/0,minAlt:1/0,maxAlt:-1/0}),M={lat:(u.minLat+u.maxLat)/2,lon:(u.minLon+u.maxLon)/2,alt:(u.minAlt+u.maxAlt)/2},A=t[0].alt,h=!0,console.log("Global coordinate system initialized:",{globalCenter:M,globalBounds:u}))}function nt(){u=null,M=null,A=null,h=!1}function D(){x&&(g.forEach(({points:t,line:e})=>{t&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(n=>n.dispose()):t.material.dispose()),x.remove(t)),e&&(e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),x.remove(e))}),g.clear(),S(),r=[],b=null,m=null,y=null)}function H(t){!t||t.length===0||(m=t.reduce((e,n)=>({minLat:Math.min(e.minLat,n.lat),maxLat:Math.max(e.maxLat,n.lat),minLon:Math.min(e.minLon,n.lon),maxLon:Math.max(e.maxLon,n.lon),minAlt:Math.min(e.minAlt,n.alt),maxAlt:Math.max(e.maxAlt,n.alt)}),{minLat:1/0,maxLat:-1/0,minLon:1/0,maxLon:-1/0,minAlt:1/0,maxAlt:-1/0}),b={lat:(m.minLat+m.maxLat)/2,lon:(m.minLon+m.maxLon)/2,alt:(m.minAlt+m.maxAlt)/2},y=t[0].alt)}function W(){d=(t,e,n)=>{let a,f,s;typeof t=="object"&&t!==null&&"lat"in t?(a=t.lat,f=t.lon,s=t.alt!==void 0?t.alt:A||y):(a=t,f=e,s=n!==void 0?n:A||y);const c=h?M:b,l=h?A:y;if(a===void 0||f===void 0||s===void 0||c===null||l===null)return new v(0,0,0);const o=c.lat*Math.PI/180,i=10,L=(f-c.lon)*Math.cos(o)*111320*i,P=(s-l)*5,w=(a-c.lat)*111320*i;return new v(L,P,-w)}}function $(t){const e=[];return t.forEach(n=>{const a=d(n.lat,n.lon,n.alt),f=(Math.random()-.5)*.01;e.push(a.x,a.y,a.z+f)}),{positions:e}}function q(t,e){const n=new B;n.setAttribute("position",new C(t.positions,3));const a=new Float32Array(t.positions.length);n.setAttribute("color",new C(a,3));const f=new Float32Array(e);f.fill(4),n.setAttribute("pointSize",new C(f,1));const s=new F({vertexColors:!0,vertexShader:R,fragmentShader:V,transparent:!1,depthTest:!0,depthWrite:!0}),c=new k(n,s);c.renderOrder=0;const l=G(),o=new O({color:l.line,transparent:!1,opacity:1,depthTest:!0,depthWrite:!0,linewidth:1e4}),i=new _(n,o);i.renderOrder=0;const L=document.getElementById("show-lines-toggle");return i.visible=L?L.checked:!1,x.add(i,c),{points:c,line:i}}function et(t,e=!1){let n;if(e?(r.push(...t),n=r):(r=[...t],n=r),n.length===0)return D(),null;g.forEach(({points:l,line:o})=>{l&&x.remove(l),o&&x.remove(o)}),g.clear(),H(n),W();const a=n.reduce((l,o)=>{const i=o.talkerId||"default";return l[i]||(l[i]=[]),l[i].push(o),l},{});for(const l in a){const o=a[l];if(o.length>1){const i=$(o),L=q(i,o.length);g.set(l,{points:L.points,line:L.line,gpsPoints:o})}}T(a,d),console.log(`Plotted ${n.length} points across ${g.size} tracks.`),p(g,r,h?u:m),z(),E();const s=h?u:m,c=h?M:b;return{dataSpan:Math.max((s.maxLat-s.minLat)*111320,(s.maxLon-s.minLon)*111320),firstPoint:t[0],firstPointVec:d(t[0].lat,t[0].lon,t[0].alt),center:c,bounds:s}}export{X as getBoundingBox,Z as getFloorY,K as getGpsToCartesian,U as getLatestPoint,Q as getMasterGpsPoints,tt as initializeCoordinateSystem,Y as initializePlotManager,et as plotGpsData,nt as resetCoordinateSystem,N as updateTrackLabelPositions};
